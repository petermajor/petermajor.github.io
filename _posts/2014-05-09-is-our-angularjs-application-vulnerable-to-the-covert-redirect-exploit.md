---
layout: post
title: Is our AngularJS application vulnerable to the Covert Redirect exploit?
date: 2014-05-09 22:06:12
categories:
- AngularJS
- security
tags:
- AngularJS
- security
published: true
author: peter_major
sitemap:
  priority: 0.6
  changefreq: weekly
---

"_Is our AngularJS application vulnerable to the Covert Redirect exploit?_" was the question I was asked at work today.

"_I'll have to get back to you..._" was my reply.

The [Covert Redirect](http://tetraph.com/covert_redirect/) exploit is a variation of the Unvalidated Redirect (a.k.a Open Redirect) exploit, listed as #10 on the [OWASP Top 10 Vulnerability List](https://www.owasp.org/index.php/Top_10_2013-Top_10).

<!--more-->

First, we'll investigate the Unvalidated Redirect exploit, then we'll come back to the Covert Redirect exploit.

## Unvalidated Redirect

The Unvalidated Redirect exploit occurs when a website puts a redirect address into a URL. The most common case where most websites do this is on login screen:

* The website requires the user to loginto view their stuff and the user is not currently logged in. The user visits: __https://www.myapp.com/mystuff__.
* The user is redirected to the login page, but the original address the user visited is put into the login URL so that the website knows where to send the user after they login: __https://www.myapp.com/login?returnUrl=/mystuff__.
* The user logs in, and the website redirects the user back to the return address: __https://www.myapp.com/mystuff__

The exploit is that if the website does not validate the return URL is apart of it's website, that the website will redirect the user to any website that is put in the URL.

So why is that a bad thing? This article from Microsoft explains it perfectly: [Preventing Open Redirection Attacks](http://www.asp.net/mvc/tutorials/security/preventing-open-redirection-attacks)

## Is our AngularJS application vulnerable?

Our AngularJS application has three features where we put a return address into the URL - one of which is the login screen.

So I hacked the login URL in browser to change the return address to be a page that is not part of our site:

From this: __https://www.myapp.com/login?returnUrl=/mystuff__<br />
To this:__https://www.myapp.com/login?returnUrl=http://www.google.com__

What happened? Our application allowed the user to login, but it redirected them to our "Page Not Found" screen (404 error).

Interesting... I wonder why it did that?

I dug into the AngularJS code for our login screen and located the redirect code:

{% highlight js %}
var returnUrl = decodeURIComponent($route.current.params.returnUrl);
$location.url(returnUrl);
{% endhighlight %}

I was still a little confused... If I call __$location.url('http://www.google.com')__ won't that redirect me to Google?

No it won't!

Before I tell you why, just a quick recap on single page application URLs...<br />
You might see this in your browser address bar: __https://www.myapp.com/login__<br />
But you are really visiting this page: __https://www.myapp.com#!/login__<br />
You can read more on "hashbang" URLs in [Using $location](https://docs.angularjs.org/guide/$location#hashbang-and-html5-modes).

It turns out that __$location.url__ takes a"path", not an absolute URL. And the path is the bit of the URL after the "#!".

So back to my example, when I call __$location.url('http://www.google.com')__ AngularJS redirects my do __https://www.myapp.com#!/http://www.google.com__. Since there is no such route defined, the user is redirected to "Page Not Found".

In AngularJS, if you want to redirect to a completely different site, you would use the command __$window.location.href="http://www.google.com"__

The good news is that we use __$location.url__ and not __$window.location.href__ in all the places where we redirect to addresses from URL parameters

The bad news is that I didn't write it that way on purpose. Well now I know!

## Covert Redirect

The Covert Redirect exploit is essentially an Unvalidated Redirect exploit. It's just that the vulnerability isn't in your application. It's in a different application that your application depends on.

A common case where this might occur is with federated security. That's basically when your site allows the user to login to a different application and to use those credentials on your system.

Our application uses [Azure ACS](http://azure.microsoft.com/en-us/documentation/articles/active-directory-dotnet-how-to-use-access-control/). When a user logs in to our application, they're redirected to Azure ACS. Azure ACS must return the user to our application after they login, so we must provide a return URL.

Azure ACS is very strict regarding the return URL. The exact return URL to your application must be specified when configuring the ACS application (relying party in ACS speak). Any attempt to redirect to a return URL that doesn't match the configured return URL will result in ACS returning an error.

## Wrap up

So the answer to the original question "Is our AngularJS application vulnerable to the Covert Redirect exploit?" is __no__.

Along the way we learned a bit more about might be a more common error that programmers can make - the Unvalidated Redirect exploit.

Maybe it's time to go through the other nine in that list, eh?
